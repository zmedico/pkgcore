# Copyright: 2014 Tim Harder <radhermit@gmail.com>
# license GPL2/BSD 3

source "${PKGCORE_BIN_PATH}"/eapi/5.lib

BANNED_FUNCS+=( einstall )

get_libdir() { __get_libdir lib; }

in_iuse() {
	[[ $1 =~ ${PKGCORE_IUSE_EFFECTIVE} ]]
}

einstalldocs() {
	local docs

	docinto .
	if ! docs=$(declare -p DOCS 2> /dev/null); then
		for docs in README* ChangeLog AUTHORS NEWS TODO CHANGES \
				THANKS BUGS FAQ CREDITS CHANGELOG; do
			[[ -s ${docs} ]] && dodoc "${docs}"
		done
	elif [[ ${docs} == "declare -a "* ]]; then
		[[ -n ${DOCS[@]} ]] && dodoc -r "${DOCS[@]}"
	else
		[[ -n ${DOCS} ]] && dodoc -r ${DOCS}
	fi

	docinto html
	if [[ $(declare -p HTML_DOCS 2> /dev/null) == "declare -a "* ]]; then
		[[ -n ${HTML_DOCS[@]} ]] && dodoc -r "${HTML_DOCS[@]}"
	else
		[[ -n ${HTML_DOCS} ]] && dodoc -r ${HTML_DOCS}
	fi
}

eapply() {
	:
}

eapply_user() {
	local patchroot=${ROOT:-/}etc/portage/patches
	local patch patches=()

	# Determine if there are patches to apply, filenames must match *.diff or
	# *.patch to be included.
	#
	# valid patch locations:
	#   - ${CATEGORY}/${PF}(:${SLOT})
	#   - ${CATEGORY}/${P}(:${SLOT})
	#   - ${CATEGORY}/${PN}(:${SLOT})
	# TODO: implement var push/pop function to handle setting LC_COLLATE=C here
	__shopt_push -s nullglob
	for patch in "${patchroot}"/${CATEGORY}/{${PF},${P},${PN}}{,:${SLOT%/*}}/*.{diff,patch}; do
		[[ -f ${patch} ]] && patches+=( ${patch} )
	done
	__shopt_pop

	if [[ -n ${patches[@]} ]]; then
		einfo "Applying user patches ..."
		eapply "${patches[@]}"
	fi
}

__phase_eapi6_src_prepare() {
	local patches

	if patches=$(declare -p PATCHES 2> /dev/null); then
		if [[ ${patches} == "declare -a "* ]]; then
			eapply "${PATCHES[@]}"
		else
			eapply ${PATCHES}
		fi
	fi

	eapply_user
}

__phase_eapi6_src_install() {
	if [[ -f Makefile || -f GNUmakefile || -f makefile ]]; then
		emake DESTDIR="${D}" install
	fi

	einstalldocs
}

__inject_phase_funcs __phase_eapi6 src_{prepare,install}

:
